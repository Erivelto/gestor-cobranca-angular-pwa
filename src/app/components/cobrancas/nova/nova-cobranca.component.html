<div class="page-container">
    <!-- Header -->
    <div class="dashboard-header">
        <button mat-icon-button class="back-button" routerLink="/cobrancas">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h1>Nova Cobrança</h1>
    </div>

    <!-- Loading State -->
    <mat-card *ngIf="loading" class="loading-card">
        <mat-card-content class="loading-content">
            <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
            <p>Carregando formulário...</p>
        </mat-card-content>
    </mat-card>

    <!-- Form Container -->
    <div *ngIf="!loading" class="form-container">

        <!-- Client Selection Section -->
        <div class="form-section">
            <mat-card>
                <mat-card-header>
                    <mat-card-title>
                        <mat-icon>person</mat-icon>
                        Seleção de Cliente
                    </mat-card-title>
                    <mat-card-subtitle>Busque e selecione o cliente para a cobrança</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <!-- Busca de Cliente -->
                    <div class="client-search">
                        <mat-form-field appearance="outline" class="client-field">
                            <mat-label>Buscar cliente</mat-label>
                            <input matInput [(ngModel)]="clienteSearch" [matAutocomplete]="clienteAutocomplete"
                                (input)="buscarClientes()" placeholder="Digite o nome do cliente">
                            <mat-icon matSuffix>search</mat-icon>
                        </mat-form-field>

                        <!-- Autocomplete do Material Design -->
                        <mat-autocomplete #clienteAutocomplete="matAutocomplete"
                            (optionSelected)="onClienteSelected($event)" [displayWith]="displayCliente">
                            <mat-option *ngFor="let cliente of clientesEncontrados" [value]="cliente">
                                <mat-icon>person</mat-icon>
                                <div class="client-info">
                                    <span class="client-name">{{ cliente.nome }}</span>
                                    <small class="client-details">
                                        {{ cliente.documento }}
                                        <span *ngIf="cliente.contatos && cliente.contatos.length > 0">
                                            • {{ cliente.contatos[0].email || 'Sem email' }}
                                        </span>
                                    </small>
                                </div>
                            </mat-option>

                            <!-- Opção para cadastrar novo cliente -->
                            <mat-option *ngIf="clienteSearch && clientesEncontrados.length === 0"
                                (click)="novoCliente()" class="new-client-option">
                                <mat-icon color="primary">person_add</mat-icon>
                                <span>Cadastrar "{{ clienteSearch }}"</span>
                            </mat-option>
                        </mat-autocomplete>
                    </div>

                    <!-- Informações do cliente selecionado -->
                    <div class="selected-client" *ngIf="clienteSelecionado">
                        <div class="info-item">
                            <mat-icon class="info-icon">check_circle</mat-icon>
                            <div class="info-text">
                                <span class="info-label">Cliente Selecionado</span>
                                <div class="selected-client-details">
                                    <strong>{{ clienteSelecionado.nome }}</strong>
                                    <small>{{ clienteSelecionado.documento }}</small>
                                    <small
                                        *ngIf="clienteSelecionado.contatos && clienteSelecionado.contatos.length > 0">
                                        {{ clienteSelecionado.contatos[0].email || 'Sem email' }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Loan Values Section -->
        <div class="form-section" *ngIf="clienteSelecionado">
            <mat-card>
                <mat-card-header>
                    <mat-card-title>
                        <mat-icon>attach_money</mat-icon>
                        Dados do Empréstimo
                    </mat-card-title>
                    <mat-card-subtitle>Informe o valor e os juros aplicados ao empréstimo</mat-card-subtitle>
                </mat-card-header>

                <mat-card-content>
                    <div class="valores-row">
                        <!-- Campo Valor do Empréstimo -->
                        <div class="form-group">
                            <div class="campo-valor">
                                <mat-icon class="info-icon">attach_money</mat-icon>
                                <div class="campo-content">
                                    <span class="info-label">Valor do Empréstimo</span>
                                    <mat-form-field appearance="outline" class="valor-field">
                                        <mat-label>Valor em R$</mat-label>
                                        <input matInput type="text" [value]="valorEmprestimoFormatado"
                                            (input)="onValorEmprestimoInput($event)"
                                            (focus)="onValorEmprestimoFocus($event)"
                                            (blur)="onValorEmprestimoBlur($event)" placeholder=" 0,00" maxlength="15">
                                        <span matTextPrefix>R$ </span>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                        <!-- Campo Dia do Vencimento -->
                        <div class="form-group">
                            <div class="campo-valor">
                                <mat-icon class="info-icon">calendar_today</mat-icon>
                                <div class="campo-content">
                                    <span class="info-label">Dia do Vencimento</span>
                                    <mat-form-field appearance="outline" class="valor-field">
                                        <mat-label>Dia do Vencimento</mat-label>
                                        <input matInput type="number" min="1" max="28" [(ngModel)]="diaVencimento" placeholder="Ex: 5">
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>

                        <!-- Campo Juros Aplicado -->
                        <div class="form-group">
                            <!-- Campo Data de Início -->
                            <div class="form-group">
                                <div class="campo-data">
                                    <mat-icon class="info-icon">event</mat-icon>
                                    <div class="campo-content">
                                        <span class="info-label">Data de Início</span>
                                        <mat-form-field appearance="outline" class="data-field">
                                            <mat-label>Data de início</mat-label>
                                            <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="dataInicio"
                                                placeholder="Selecione a data">
                                            <mat-datepicker-toggle matSuffix
                                                [for]="pickerInicio"></mat-datepicker-toggle>
                                            <mat-datepicker #pickerInicio></mat-datepicker>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div class="campo-juros">
                                <mat-icon class="info-icon">percent</mat-icon>
                                <div class="campo-content">
                                    <span class="info-label">Juros Aplicado</span>
                                    <mat-form-field appearance="outline" class="juros-field">
                                        <mat-label>Valor aplicado</mat-label>
                                        <input matInput type="text" [value]="taxaJurosFormatada"
                                            (input)="onTaxaJurosInput($event)" (focus)="onTaxaJurosFocus($event)"
                                            (blur)="onTaxaJurosBlur($event)">
                                        <span matTextSuffix>%</span>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                        <!-- Valor Total -->
                        <div class="form-group">
                            <div class="campo-valor">
                                <mat-icon class="info-icon">summarize</mat-icon>
                                <div class="campo-content">
                                    <span class="info-label">Valor Total</span>
                                    <span class="info-value total-value">{{ totalComJuros | currency:'BRL':'symbol':'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Form Actions -->
        <div class="form-actions" *ngIf="clienteSelecionado && valorEmprestimo > 0">
            <div class="button-row">
                <button mat-button routerLink="/cobrancas">
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                </button>
                <button mat-raised-button color="primary" (click)="salvarEmprestimo()">
                    <mat-icon>add</mat-icon>
                    Adicionar Empréstimo
                    <mat-progress-spinner *ngIf="loading" diameter="20" mode="indeterminate" color="accent"
                        style="vertical-align: middle;"></mat-progress-spinner>
                </button>
            </div>
        </div>