<div class="nova-cobranca-container">
  <mat-card class="form-card">
    <div class="header-row">
      <div class="title-block">
        <h2 class="title">Nova Cobrança</h2>
        <p class="subtitle">Preencha os dados da cobrança</p>
      </div>
      <button mat-icon-button color="primary" routerLink="/cobrancas" matTooltip="Voltar">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>

    <mat-divider></mat-divider>

    <mat-card-content>
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-overlay">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
        <p>Carregando formulário...</p>
      </div>

      <div *ngIf="!loading">
        <div class="form-grid">
          <!-- Seleção de Cliente -->
          <div class="section-title full-width">
            <mat-icon>person</mat-icon>
            <h3>Cliente</h3>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Buscar cliente</mat-label>
            <input matInput [(ngModel)]="clienteSearch" [matAutocomplete]="clienteAutocomplete"
              (input)="buscarClientes()" placeholder="Digite para buscar">
            <mat-icon matPrefix>search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="clienteSearch"
              (click)="clienteSearch=''; buscarClientes()" matTooltip="Limpar busca">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>

          <mat-autocomplete #clienteAutocomplete="matAutocomplete"
            (optionSelected)="onClienteSelected($event)" [displayWith]="displayCliente">
            <mat-option *ngFor="let cliente of clientesEncontrados" [value]="cliente">
              <div class="cliente-option">
                <span class="cliente-nome">{{ cliente.nome }}</span>
                <small>{{ cliente.documento }}</small>
              </div>
            </mat-option>
            <mat-option *ngIf="clienteSearch && clientesEncontrados.length === 0" (click)="novoCliente()">
              <span>Cadastrar "{{ clienteSearch }}"</span>
            </mat-option>
          </mat-autocomplete>

          <!-- Informações do cliente selecionado -->
          <div *ngIf="clienteSelecionado" class="cliente-info full-width">
            <mat-icon>check_circle</mat-icon>
            <div>
              <strong>{{ clienteSelecionado.nome }}</strong>
              <small>{{ clienteSelecionado.documento }}</small>
            </div>
          </div>

          <!-- Dados do Empréstimo -->
          <div *ngIf="clienteSelecionado" class="section-title full-width">
            <mat-icon>attach_money</mat-icon>
            <h3>Dados do Empréstimo</h3>
          </div>

          <mat-form-field appearance="outline" *ngIf="clienteSelecionado">
            <mat-label>Valor do Empréstimo</mat-label>
            <input matInput type="text" [value]="valorEmprestimoFormatado"
              (input)="onValorEmprestimoInput($event)" (focus)="onValorEmprestimoFocus($event)"
              (blur)="onValorEmprestimoBlur($event)" placeholder="0,00">
            <span matTextPrefix>R$ </span>
            <mat-icon matPrefix>attach_money</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="clienteSelecionado">
            <mat-label>Tipo de Cobrança</mat-label>
            <mat-select [(ngModel)]="tipoCobranca">
              <mat-option value="semanal">Semanal</mat-option>
              <mat-option value="quinzenal">Quinzenal</mat-option>
              <mat-option value="mensal">Mensal</mat-option>
            </mat-select>
            <mat-icon matPrefix>calendar_today</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width" *ngIf="clienteSelecionado">
            <mat-label>Data de início</mat-label>
            <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="dataInicio">
            <mat-datepicker-toggle matSuffix [for]="pickerInicio"></mat-datepicker-toggle>
            <mat-datepicker #pickerInicio></mat-datepicker>
            <mat-icon matPrefix>event</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="clienteSelecionado">
            <mat-label>Juros Aplicado</mat-label>
            <input matInput type="text" [value]="taxaJurosFormatada"
              (input)="onTaxaJurosInput($event)" (focus)="onTaxaJurosFocus($event)"
              (blur)="onTaxaJurosBlur($event)">
            <span matTextSuffix>%</span>
            <mat-icon matPrefix>percent</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="clienteSelecionado">
            <mat-label>Multa</mat-label>
            <input matInput type="text" [value]="multaFormatada"
              (input)="onMultaInput($event)" (focus)="onMultaFocus($event)"
              (blur)="onMultaBlur($event)" placeholder="0,00">
            <span matTextPrefix>R$ </span>
            <mat-icon matPrefix>warning</mat-icon>
          </mat-form-field>

          <!-- Valor Total -->
          <div *ngIf="clienteSelecionado && valorEmprestimo > 0" class="valor-total full-width">
            <mat-icon>account_balance_wallet</mat-icon>
            <div>
              <span class="label">Valor Total</span>
              <span class="value">{{ totalComJuros | currency:'BRL':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>

    <mat-divider *ngIf="clienteSelecionado && valorEmprestimo > 0"></mat-divider>

    <mat-card-actions *ngIf="clienteSelecionado && valorEmprestimo > 0">
      <button mat-raised-button color="primary" (click)="salvarEmprestimo()" [disabled]="loading">
        <mat-icon *ngIf="!loading">save</mat-icon>
        <mat-progress-spinner *ngIf="loading" diameter="20" mode="indeterminate"></mat-progress-spinner>
        Adicionar Empréstimo
      </button>
      <button mat-button routerLink="/cobrancas" [disabled]="loading">
        Cancelar
      </button>
    </mat-card-actions>
  </mat-card>
</div>