<div class="table-container">
  <!-- Header com busca e ações -->
  <div class="table-header" *ngIf="showSearch || selection.hasValue()">
    <!-- Barra de busca -->
    <mat-form-field class="search-field" appearance="outline" *ngIf="showSearch">
      <mat-label>Buscar...</mat-label>
      <input matInput 
             [(ngModel)]="searchTerm" 
             (input)="applyFilter()"
             placeholder="Digite para buscar">
      <mat-icon matPrefix>search</mat-icon>
      <button mat-icon-button 
              matSuffix 
              *ngIf="searchTerm" 
              (click)="searchTerm=''; applyFilter()"
              matTooltip="Limpar busca">
        <mat-icon>clear</mat-icon>
      </button>
    </mat-form-field>

    <!-- Ações em lote -->
    <div class="bulk-actions" *ngIf="selection.hasValue()">
      <mat-chip-listbox class="selection-info">
        <mat-chip-option selected>
          {{ selection.selected.length }} item(s) selecionado(s)
        </mat-chip-option>
      </mat-chip-listbox>
      
      <button mat-stroked-button color="warn" matTooltip="Excluir selecionados">
        <mat-icon>delete</mat-icon>
        Excluir
      </button>
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-wrapper">
    <table mat-table 
           [dataSource]="dataSource" 
           matSort 
           class="advanced-table"
           [class.loading]="loading">

      <!-- Coluna de seleção -->
      <ng-container matColumnDef="select" *ngIf="showSelection">
        <th mat-header-cell *matHeaderCellDef class="select-column">
          <mat-checkbox (change)="toggleAllRows()"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()"
                        matTooltip="Selecionar todos">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" class="select-column">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="toggleRow(row)"
                        [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Colunas dinâmicas -->
      <ng-container [matColumnDef]="column.key" *ngFor="let column of columns">
        <th mat-header-cell 
            *matHeaderCellDef 
            [mat-sort-header]="column.sortable ? column.key : ''"
            [style.width]="column.width || 'auto'"
            [style.text-align]="column.align || 'left'">
          {{ column.label }}
        </th>
        <td mat-cell 
            *matCellDef="let row" 
            [style.text-align]="column.align || 'left'"
            (click)="onRowClick(row)">
          
          <!-- Conteúdo baseado no tipo -->
          <ng-container [ngSwitch]="column.type">
            <!-- Status -->
            <mat-chip *ngSwitchCase="'status'" 
                      [class]="getStatusClass(getColumnValue(row, column))">
              {{ getColumnValue(row, column) }}
            </mat-chip>
            
            <!-- Moeda -->
            <span *ngSwitchCase="'currency'" class="currency-value">
              {{ formatValue(getColumnValue(row, column), 'currency') }}
            </span>
            
            <!-- Data -->
            <span *ngSwitchCase="'date'" class="date-value">
              {{ formatValue(getColumnValue(row, column), 'date') }}
            </span>
            
            <!-- Número -->
            <span *ngSwitchCase="'number'" class="number-value">
              {{ formatValue(getColumnValue(row, column), 'number') }}
            </span>
            
            <!-- Texto padrão -->
            <span *ngSwitchDefault>
              {{ getColumnValue(row, column) }}
            </span>
          </ng-container>
        </td>
      </ng-container>

      <!-- Coluna de ações -->
      <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
        <th mat-header-cell *matHeaderCellDef class="actions-column">Ações</th>
        <td mat-cell *matCellDef="let row" class="actions-column">
          <button mat-icon-button 
                  [matMenuTriggerFor]="actionsMenu"
                  matTooltip="Ações">
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #actionsMenu="matMenu">
            <button mat-menu-item 
                    *ngFor="let action of actions"
                    [disabled]="!isActionVisible(action, row)"
                    (click)="executeAction(action, row)">
              <mat-icon [color]="action.color || 'primary'">{{ action.icon }}</mat-icon>
              <span>{{ action.label }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Header row -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      
      <!-- Data rows -->
      <tr mat-row 
          *matRowDef="let row; columns: displayedColumns;"
          class="data-row"
          [class.selected]="selection.isSelected(row)">
      </tr>

      <!-- No data row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
          <div class="no-data-container">
            <mat-icon class="no-data-icon">inbox</mat-icon>
            <p class="no-data-message">{{ emptyMessage }}</p>
          </div>
        </td>
      </tr>
    </table>

    <!-- Loading overlay -->
    <div class="loading-overlay" *ngIf="loading">
      <mat-icon class="loading-spinner">refresh</mat-icon>
      <p>Carregando dados...</p>
    </div>
  </div>

  <!-- Paginação -->
  <mat-paginator *ngIf="showPagination"
                 [pageSizeOptions]="[5, 10, 20, 50]"
                 [pageSize]="pageSize"
                 showFirstLastButtons
                 class="table-paginator">
  </mat-paginator>
</div>