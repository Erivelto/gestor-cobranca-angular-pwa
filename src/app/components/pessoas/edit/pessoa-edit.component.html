<div class="page-container">
  <div class="dashboard-header">
    <div class="header-title">
      <h1>Editar Cliente Avançado</h1>
      <p *ngIf="pessoa.nome" class="subtitle">{{ pessoa.nome }}</p>
    </div>
    <button 
      mat-icon-button 
      (click)="voltar()" 
      matTooltip="Voltar"
      class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    <p>Carregando dados da pessoa...</p>
  </div>

  <!-- Dados Básicos -->
  <mat-card class="form-section" *ngIf="!loading">
    <mat-card-title>Dados Básicos</mat-card-title>
    <mat-card-content>
      <form class="form-container">
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-group">
            <mat-label>Código</mat-label>
            <input
              matInput
              type="text"
              name="codigo"
              [(ngModel)]="pessoa.codigo"
              placeholder="Ex: PES001"
              [disabled]="loading"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-group">
            <mat-label>Nome Completo</mat-label>
            <input
              matInput
              type="text"
              name="nome"
              [(ngModel)]="pessoa.nome"
              placeholder="Digite o nome completo"
              [disabled]="loading"
            />
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="form-group">
            <mat-label>CPF/CNPJ</mat-label>
            <input
              matInput
              type="text"
              name="documento"
              [(ngModel)]="pessoa.documento"
              placeholder="000.000.000-00"
              [disabled]="loading"
            />
            <mat-hint>Digite apenas números</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-group">
            <mat-label>Status</mat-label>
            <mat-select
              name="status"
              [(ngModel)]="pessoa.status"
              [disabled]="loading"
            >
              <mat-option [value]="1">Ativo</mat-option>
              <mat-option [value]="0">Inativo</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="updatePessoa()" [disabled]="loading">
            <mat-icon>save</mat-icon>
            Salvar Alterações
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Contatos -->
  <mat-card class="form-section" *ngIf="!loading">
    <mat-card-title>
      Contatos
    </mat-card-title>
    <mat-card-content>
      <!-- Lista de Contatos -->
      <div *ngIf="contatosPrincipais.length > 0" class="items-list">
        <mat-card *ngFor="let contato of contatosPrincipais; let i = index" class="item-card">
          <mat-card-content>
            <div *ngIf="editingContato !== contatos.indexOf(contato)" class="item-display">
              <div class="item-info">
                <span class="item-type">{{ getTipoContatoText(contato.tipo) }}</span>
                <div class="contact-details">
                  <span *ngIf="contato.ddd && contato.celular" class="item-value">
                    Telefone: ({{ contato.ddd }}) {{ contato.celular }}
                  </span>
                  <span *ngIf="contato.email" class="item-value">E-mail: {{ contato.email }}</span>
                  <span *ngIf="contato.site" class="item-value">Site/Redes: {{ contato.site }}</span>
                </div>
              </div>
              <div class="item-actions">
                <button mat-icon-button color="primary" (click)="editContato(contatos.indexOf(contato))">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteContato(contato.codigo!, contatos.indexOf(contato))">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div *ngIf="editingContato === contatos.indexOf(contato)" class="item-edit">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Tipo</mat-label>
                  <mat-select [(ngModel)]="contato.tipo" name="tipoContato{{i}}">
                    <mat-option value="celular">Celular</mat-option>
                    <mat-option value="telefone">Telefone</mat-option>
                    <mat-option value="email">E-mail</mat-option>
                    <mat-option value="whatsapp">WhatsApp</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group small">
                  <mat-label>DDD</mat-label>
                  <input matInput [(ngModel)]="contato.ddd" name="ddd{{i}}" maxlength="2" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Celular</mat-label>
                  <input matInput [(ngModel)]="contato.celular" name="celular{{i}}" maxlength="9" />
                </mat-form-field>
              </div>

              <div class="form-row single">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>E-mail</mat-label>
                  <input matInput [(ngModel)]="contato.email" name="email{{i}}" type="email" />
                </mat-form-field>
              </div>

              <div class="form-row single">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Site</mat-label>
                  <input matInput [(ngModel)]="contato.site" name="site{{i}}" />
                </mat-form-field>
              </div>

              <div class="edit-actions">
                <button mat-button color="primary" (click)="saveContato(contato)">
                  <mat-icon>save</mat-icon>
                  Salvar
                </button>
                <button mat-button (click)="editingContato = null">
                  <mat-icon>cancel</mat-icon>
                  Cancelar
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Adicionar Novo Contato -->
      <div *ngIf="showAddContato" class="add-form">
        <mat-card class="add-card">
          <mat-card-title>Novo Contato</mat-card-title>
          <mat-card-content>
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Tipo de Contato</mat-label>
                <mat-select [(ngModel)]="novoContato.tipo" name="novoTipoContato">
                  <mat-option value="celular">Celular</mat-option>
                  <mat-option value="telefone">Telefone</mat-option>
                  <mat-option value="email">E-mail</mat-option>
                  <mat-option value="whatsapp">WhatsApp</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group small">
                <mat-label>DDD</mat-label>
                <input matInput [(ngModel)]="novoContato.ddd" name="ddd" placeholder="11" maxlength="2" 
                       (input)="formatDDD($event)" />
              </mat-form-field>
            </div>

            <div class="form-row single">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Número do Telefone</mat-label>
                <input matInput [(ngModel)]="novoContato.celular" name="celular" 
                       placeholder="99999-9999" maxlength="10"
                       (input)="formatTelefone($event)" />
                <mat-hint>Apenas números (sem espaços ou traços)</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-row single">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>E-mail</mat-label>
                <input matInput [(ngModel)]="novoContato.email" name="email" type="email" 
                       placeholder="exemplo@email.com" />
              </mat-form-field>
            </div>

            <div class="form-row single">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Site/Redes Sociais</mat-label>
                <input matInput [(ngModel)]="novoContato.site" name="site" 
                       placeholder="Facebook / Instagram" />
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-raised-button color="primary" (click)="addContato()">
                <mat-icon>add</mat-icon>
                Adicionar
              </button>
              <button mat-button (click)="showAddContato = false; resetNovoContato()">
                <mat-icon>cancel</mat-icon>
                Cancelar
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="contatosPrincipais.length === 0 && !showAddContato" class="empty-state">
        <mat-icon>phone</mat-icon>
        <p>Nenhum contato cadastrado</p>
        <button mat-button color="primary" (click)="showAddContato = true">
          Adicionar primeiro contato
        </button>
      </div>

      <!-- Botão para adicionar novo contato quando já há contatos -->
      <div *ngIf="contatosPrincipais.length > 0 && !showAddContato" class="add-new-button">
        <button mat-raised-button color="primary" (click)="showAddContato = true">
          <mat-icon>add</mat-icon>
          Adicionar novo contato
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Contatos Adicionais -->
  <mat-card class="form-section" *ngIf="!loading">
    <mat-card-title>
      Contatos Adicionais
    </mat-card-title>
    <mat-card-content>
      <!-- Lista de Contatos Adicionais -->
      <div *ngIf="contatosAdicionais.length > 0" class="items-list">
        <mat-card *ngFor="let contato of contatosAdicionais; let i = index" class="item-card">
          <mat-card-content>
            <div *ngIf="editingContatoAdic !== contatos.indexOf(contato)" class="item-display">
              <div class="item-info">
                <div class="contact-details">
                  <span *ngIf="contato.descricaoAdic" class="item-value">Descrição: {{ contato.descricaoAdic }}</span>
                  <span *ngIf="contato.dddAdic && contato.celularAdic" class="item-value">
                    Telefone: ({{ contato.dddAdic }}) {{ contato.celularAdic }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <button mat-icon-button color="primary" (click)="editingContatoAdic = contatos.indexOf(contato)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteContatoAdic(contato)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div *ngIf="editingContatoAdic === contatos.indexOf(contato)" class="item-edit">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>DDD (Adicional)</mat-label>
                  <input matInput [(ngModel)]="contato.dddAdic" name="dddAdic{{i}}" maxlength="2" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Celular (Adicional)</mat-label>
                  <input matInput [(ngModel)]="contato.celularAdic" name="celularAdic{{i}}" maxlength="9" />
                </mat-form-field>
              </div>

              <div class="form-row single">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Descrição (Adicional)</mat-label>
                  <input matInput [(ngModel)]="contato.descricaoAdic" name="descricaoAdic{{i}}" 
                         placeholder="Ex: Comercial, Recado, etc." />
                </mat-form-field>
              </div>

              <div class="edit-actions">
                <button mat-button color="primary" (click)="saveContato(contato)">
                  <mat-icon>save</mat-icon>
                  Salvar
                </button>
                <button mat-button (click)="editingContatoAdic = null">
                  <mat-icon>cancel</mat-icon>
                  Cancelar
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="contatosAdicionais.length === 0" class="empty-state">
        <mat-icon>phone</mat-icon>
        <p>Nenhum contato adicional cadastrado</p>
        <button mat-button color="primary" (click)="showAddContatoAdic = true">
          Adicionar primeiro contato adicional
        </button>
      </div>

      <!-- Adicionar Novo Contato Adicional -->
      <div *ngIf="showAddContatoAdic && contatos.length > 0" class="add-form">
        <mat-card class="add-card">
          <mat-card-title>Novo Contato Adicional</mat-card-title>
          <mat-card-content>
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-group small">
                <mat-label>DDD (Adicional)</mat-label>
                <input matInput [(ngModel)]="novoContatoAdic.dddAdic" name="novoDddAdic" placeholder="11" maxlength="2" 
                       (input)="formatDDDAdic($event)" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Celular (Adicional)</mat-label>
                <input matInput [(ngModel)]="novoContatoAdic.celularAdic" name="novoCelularAdic" 
                       placeholder="99999-9999" maxlength="10"
                       (input)="formatTelefoneAdic($event)" />
                <mat-hint>Apenas números (sem espaços ou traços)</mat-hint>
              </mat-form-field>
            </div>

            <div class="form-row single">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Descrição (Adicional)</mat-label>
                <input matInput [(ngModel)]="novoContatoAdic.descricaoAdic" name="novaDescricaoAdic" 
                       placeholder="Ex: Comercial, Recado, etc." />
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-raised-button color="primary" (click)="addContatoAdic()">
                <mat-icon>add</mat-icon>
                Adicionar
              </button>
              <button mat-button (click)="showAddContatoAdic = false; resetNovoContatoAdic()">
                <mat-icon>cancel</mat-icon>
                Cancelar
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Botão para adicionar novo contato adicional -->
      <div *ngIf="contatosAdicionais.length > 0 && !showAddContatoAdic" class="add-new-button">
        <button mat-raised-button color="primary" (click)="showAddContatoAdic = true">
          <mat-icon>add</mat-icon>
          Adicionar novo contato adicional
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Endereços -->
  <mat-card class="form-section" *ngIf="!loading">
    <mat-card-title>
      Endereços
    </mat-card-title>
    <mat-card-content>
      <!-- Lista de Endereços -->
      <div *ngIf="enderecos.length > 0" class="items-list">
        <mat-card *ngFor="let endereco of enderecos; let i = index" class="item-card">
          <mat-card-content>
            <div *ngIf="editingEndereco !== i" class="item-display">
              <div class="item-info address-info">
                <div class="address-line">{{ endereco.logradouro }}, {{ endereco.numrero }}</div>
                <div class="address-details">{{ endereco.bairro }} - {{ endereco.cidade }}/{{ endereco.uf }}</div>
                <div class="address-cep">CEP: {{ endereco.cep }}</div>
              </div>
              <div class="item-actions">
                <button mat-icon-button color="primary" (click)="editEndereco(i)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteEndereco(endereco.codigo!, i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div *ngIf="editingEndereco === i" class="item-edit">
              <div class="form-row">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>CEP</mat-label>
                  <input matInput [(ngModel)]="endereco.cep" name="cep{{i}}" (blur)="buscarCep(endereco)" [disabled]="loadingCep" />
                  <mat-hint *ngIf="loadingCep">Buscando CEP...</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Logradouro</mat-label>
                  <input matInput [(ngModel)]="endereco.logradouro" name="logradouro{{i}}" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group small">
                  <mat-label>Número</mat-label>
                  <input matInput [(ngModel)]="endereco.numrero" name="numero{{i}}" />
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Complemento</mat-label>
                  <input matInput [(ngModel)]="endereco.complemento" name="complemento{{i}}" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Bairro</mat-label>
                  <input matInput [(ngModel)]="endereco.bairro" name="bairro{{i}}" />
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="form-group">
                  <mat-label>Cidade</mat-label>
                  <input matInput [(ngModel)]="endereco.cidade" name="cidade{{i}}" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-group small">
                  <mat-label>Estado</mat-label>
                  <input matInput [(ngModel)]="endereco.uf" name="estado{{i}}" maxlength="2" />
                </mat-form-field>
              </div>

              <div class="edit-actions">
                <button mat-button color="primary" (click)="saveEndereco(endereco)">
                  <mat-icon>save</mat-icon>
                  Salvar
                </button>
                <button mat-button (click)="editingEndereco = null">
                  <mat-icon>cancel</mat-icon>
                  Cancelar
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Adicionar Novo Endereço -->
      <div *ngIf="showAddEndereco" class="add-form">
        <mat-card class="add-card">
          <mat-card-title>Novo Endereço</mat-card-title>
          <mat-card-content>
            <div class="form-row">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>CEP</mat-label>
                <input matInput [(ngModel)]="novoEndereco.cep" name="novoCep" (blur)="buscarCep(novoEndereco)" [disabled]="loadingCep" />
                <mat-hint *ngIf="loadingCep">Buscando CEP...</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Logradouro</mat-label>
                <input matInput [(ngModel)]="novoEndereco.logradouro" name="novoLogradouro" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group small">
                <mat-label>Número</mat-label>
                <input matInput [(ngModel)]="novoEndereco.numrero" name="novoNumero" />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Complemento</mat-label>
                <input matInput [(ngModel)]="novoEndereco.complemento" name="novoComplemento" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Bairro</mat-label>
                <input matInput [(ngModel)]="novoEndereco.bairro" name="novoBairro" />
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-group">
                <mat-label>Cidade</mat-label>
                <input matInput [(ngModel)]="novoEndereco.cidade" name="novoCidade" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-group small">
                <mat-label>Estado</mat-label>
                <input matInput [(ngModel)]="novoEndereco.uf" name="novoEstado" maxlength="2" />
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-raised-button color="primary" (click)="addEndereco()">
                <mat-icon>add</mat-icon>
                Adicionar
              </button>
              <button mat-button (click)="showAddEndereco = false; resetNovoEndereco()">
                <mat-icon>cancel</mat-icon>
                Cancelar
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="enderecos.length === 0 && !showAddEndereco" class="empty-state">
        <mat-icon>location_on</mat-icon>
        <p>Nenhum endereço cadastrado</p>
        <button mat-button color="primary" (click)="showAddEndereco = true">
          Adicionar primeiro endereço
        </button>
      </div>

      <!-- Botão para adicionar novo endereço quando já há endereços -->
      <div *ngIf="enderecos.length > 0 && !showAddEndereco" class="add-new-button">
        <button mat-raised-button color="primary" (click)="showAddEndereco = true">
          <mat-icon>add</mat-icon>
          Adicionar novo endereço
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>